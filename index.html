<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Architect Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        #cy { width: 100%; height: 100%; }
        .transition-theme { transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease; }
    </style>
</head>
<body class="transition-theme bg-slate-50 text-slate-900 dark:bg-[#0f172a] dark:text-slate-100 h-screen flex flex-col overflow-hidden">

    <header class="h-16 border-b border-slate-200 dark:border-slate-800 px-6 flex justify-between items-center bg-white/50 dark:bg-[#0f172a]/50 backdrop-blur-md z-50">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                </div>
                <h1 class="font-extrabold text-xl tracking-tight">Graph<span class="text-indigo-600">Lab</span></h1>
            </div>
            <div id="typeIndicator" class="px-3 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-[10px] font-bold uppercase tracking-widest text-slate-500">Auto-Detecting</div>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl border border-slate-200 dark:border-slate-700">
                <button id="setDirected" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm">Directed</button>
                <button id="setUndirected" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500">Undirected</button>
            </div>
            <button id="themeToggle" class="p-2.5 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-800 hover:scale-105 transition-all shadow-sm">
                <span id="themeIcon">‚òÄÔ∏è</span>
            </button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-96 flex flex-col border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-[#1e293b]/30">
            <div class="p-5 flex flex-col h-full gap-4">
                <div class="space-y-1">
                    <h2 class="text-sm font-bold text-slate-400 uppercase tracking-tighter">Input Source</h2>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Paste an Adj List, JSON, or JS Object.</p>
                </div>

                <textarea id="editor" 
                    class="flex-1 w-full p-4 font-mono text-sm rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-[#020617] focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all shadow-inner"
                    spellcheck="false">/**
 * Smart Input:
 * Try "A: B, C" or JSON
 */
const graph = {
  "Router_1": ["Switch_A", "Switch_B"],
  "Switch_A": ["PC_1", "PC_2"],
  "Switch_B": ["Server_1"],
  "Server_1": ["Router_1"]
}</textarea>

                <div class="flex gap-2">
                    <button id="clearBtn" class="flex-1 py-3 text-sm font-bold border border-slate-200 dark:border-slate-700 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all">Clear</button>
                    <button id="runBtn" class="flex-[2] py-3 text-sm font-bold bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg shadow-indigo-500/40 transition-all">Generate Graph</button>
                </div>
            </div>
        </aside>

        <section class="flex-1 relative bg-[radial-gradient(#e2e8f0_1px,transparent_1px)] dark:bg-[radial-gradient(#1e293b_1px,transparent_1px)] [background-size:20px_20px]">
            <div id="cy"></div>
            
            <div class="absolute top-6 right-6 flex flex-col gap-2">
                <div class="px-4 py-2 bg-white/80 dark:bg-slate-900/80 backdrop-blur rounded-lg border border-slate-200 dark:border-slate-800 shadow-xl text-[11px]">
                    <span class="text-slate-400 italic">Pro Tip: Scroll to zoom, drag to move nodes.</span>
                </div>
            </div>
        </section>
    </main>

    <script>
        let cy;
        let forceMode = 'auto'; // 'auto', 'directed', 'undirected'
        const editor = document.getElementById('editor');
        const themeToggle = document.getElementById('themeToggle');
        const htmlRoot = document.documentElement;

        // --- THEME ENGINE ---
        function toggleTheme() {
            htmlRoot.classList.toggle('dark');
            const isDark = htmlRoot.classList.contains('dark');
            document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if (cy) updateGraphStyle();
        }

        // --- SMART PARSER & NORMALIZER ---
        function parseInput(input) {
            let data = {};
            let elements = [];
            const nodes = new Set();
            const edges = [];
            const edgeTracker = new Set();

            let clean = input.trim();
            // 1. Remove Variable Declarations (const g = ...)
            if (clean.includes('=')) {
                clean = clean.split('=')[1].trim().replace(/;$/, '');
            }
            // 2. Remove Block Comments
            clean = clean.replace(/\/\*[\s\S]*?\*\/|\/\/.*/g, "");

            try {
                // Try JSON / Object
                data = JSON.parse(clean.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g, '"$2":').replace(/'/g, '"'));
            } catch (e) {
                // Fallback to Adj List Text
                const lines = input.split('\n');
                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length > 1) {
                        data[parts[0].trim()] = parts[1].split(',').map(v => v.trim()).filter(v => v);
                    }
                });
            }

            // 3. Process into Cytoscape Format
            const keys = Object.keys(data);
            let hasReciprocity = false;

            keys.forEach(source => {
                nodes.add(source);
                const targets = Array.isArray(data[source]) ? data[source] : [data[source]];
                
                targets.forEach(target => {
                    const targetStr = String(target);
                    nodes.add(targetStr);

                    // Normalization: Sort IDs to prevent parallel lines in undirected mode
                    const pair = [source, targetStr].sort();
                    const edgeId = `e_${pair[0]}_${pair[1]}`;
                    
                    if (forceMode === 'undirected' || (forceMode === 'auto' && input.toLowerCase().includes('undirected'))) {
                        if (!edgeTracker.has(edgeId)) {
                            edgeTracker.add(edgeId);
                            edges.push({ data: { id: edgeId, source: source, target: targetStr } });
                        }
                    } else {
                        // Directed mode: allow A->B and B->A as separate curves
                        edges.push({ data: { id: `e_${source}_${targetStr}_${Math.random()}`, source: source, target: targetStr } });
                    }
                });
            });

            nodes.forEach(id => elements.push({ data: { id } }));
            return [...elements, ...edges];
        }

        // --- GRAPH RENDERER ---
        function render() {
            const elements = parseInput(editor.value);
            const isUndirected = forceMode === 'undirected' || (forceMode === 'auto' && editor.value.toLowerCase().includes('undirected'));
            
            document.getElementById('typeIndicator').innerText = isUndirected ? 'Mode: Undirected' : 'Mode: Directed';

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                boxSelectionEnabled: false,
                autounselectify: true,
                style: getGraphStyle(),
                layout: { 
                    name: 'cose', 
                    animate: true, 
                    refresh: 20, 
                    nodeRepulsion: 8000, 
                    idealEdgeLength: 100 
                }
            });
        }

        function getGraphStyle() {
            const isDark = htmlRoot.classList.contains('dark');
            const isUndirected = forceMode === 'undirected' || (forceMode === 'auto' && editor.value.toLowerCase().includes('undirected'));

            return [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(id)',
                        'background-color': '#4f46e5',
                        'color': isDark ? '#f1f5f9' : '#1e293b',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'width': 45,
                        'height': 45,
                        'font-family': 'Plus Jakarta Sans',
                        'font-weight': 'bold',
                        'font-size': '10px',
                        'border-width': 4,
                        'border-color': isDark ? '#0f172a' : '#ffffff',
                        'border-opacity': 1,
                        'text-outline-color': isDark ? '#0f172a' : '#ffffff',
                        'text-outline-width': 2
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': isDark ? '#334155' : '#cbd5e1',
                        'target-arrow-color': isDark ? '#334155' : '#cbd5e1',
                        'target-arrow-shape': isUndirected ? 'none' : 'triangle',
                        'curve-style': isUndirected ? 'haystack' : 'bezier',
                        'arrow-scale': 1.5,
                        'line-cap': 'round'
                    }
                },
                {
                    selector: 'node:selected',
                    style: { 'background-color': '#818cf8', 'border-color': '#4f46e5' }
                }
            ];
        }

        function updateGraphStyle() {
            cy.style(getGraphStyle()).update();
        }

        // --- EVENT LISTENERS ---
        themeToggle.addEventListener('click', toggleTheme);
        document.getElementById('runBtn').addEventListener('click', render);
        document.getElementById('clearBtn').addEventListener('click', () => { editor.value = ''; });

        const dirBtn = document.getElementById('setDirected');
        const undirBtn = document.getElementById('setUndirected');

        dirBtn.addEventListener('click', () => {
            forceMode = 'directed';
            dirBtn.className = "px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm";
            undirBtn.className = "px-3 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500";
            render();
        });

        undirBtn.addEventListener('click', () => {
            forceMode = 'undirected';
            undirBtn.className = "px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white dark:bg-slate-700 shadow-sm";
            dirBtn.className = "px-3 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-500";
            render();
        });

        // Initialize theme from storage
        if (localStorage.getItem('theme') === 'light') {
            htmlRoot.classList.remove('dark');
            document.getElementById('themeIcon').innerText = 'üåô';
        }

        window.onload = render;
    </script>
</body>
</html>
